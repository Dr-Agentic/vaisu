{
  "metadata": {
    "creator": "Maestro",
    "created_at": "2026-01-27T00:00:00Z",
    "original_prompt": "Migration: Document Structure to AI Workflow...",
    "status": "ready-to-process"
  },
  "task": {
    "title": "Migrate Structured View to AI-Driven Workflow",
    "revised_prompt": "Refactor the 'Structured View' generation process to replace the legacy regex-based parser with an insight-driven AI workflow. \n\nCurrently, `DocumentParser` uses regex to split text into sections based on headings. The goal is to defer this structural analysis to the `VisualizationGenerator` using an LLM to extract a 'Punching Message' outlineâ€”focusing on the 'So What?' of each section rather than just headers.\n\n### Core Objectives\n1. **AI-Driven Structure**: Replace static parsing with LLM-generated structure.\n2. **'Punching Message' Philosophy**: Summaries must convey the core insight, not just the topic.\n3. **Flat-to-Tree Reconstruction**: The LLM will return a flat list (Level 1-5); the backend must reconstruct the nested hierarchy.\n\n### Implementation Steps\n\n1. **Create Prompt**: Add `backend/src/prompts/structureAnalysisPrompt.ts`.\n   - **System Prompt**: Act as an elite editor. Extract logical sections.\n   - **Output Format**: JSON list of objects `{ title, level, summary, punching_message, start_index (approx) }`.\n   - **Constraints**: Max depth 5. 'Punching Message' must answer 'So what?'.\n\n2. **Update Visualization Generator**: Modify `backend/src/services/visualization/visualizationGenerator.ts`.\n   - Update `generateStructuredView` to be `async`.\n   - Call LLM with the new prompt.\n   - Implement a private helper `reconstructHierarchy(flatSections)` to convert the LLM's flat list into the recursive `Section` structure (matching `shared/src/types.ts`).\n   - **Fallback**: If LLM fails, fall back to the existing `document.structure` (which comes from the initial regex parse) to ensure resilience.\n\n3. **Verify Route Handling**: Check `backend/src/routes/documents.ts`.\n   - Ensure the visualization endpoint correctly awaits the now-async `generateStructuredView`.\n   - (Analysis of `documents.ts` suggests it already awaits `generateVisualization`, but double-check the switch case in `visualizationGenerator.ts` handles the async call correctly).\n\n4. **Testing**: Create `backend/src/services/visualization/__tests__/structure_ai.test.ts`.\n   - Mock the LLM client.\n   - Test Case 1: Flat list [L1, L2, L2, L1, L3] -> Correct Tree Structure.\n   - Test Case 2: Max depth handling.\n   - Test Case 3: Empty list handling.\n",
    "user_stories": [
      {
        "title": "Insightful Outline",
        "as_a": "Executive Reader",
        "i_want_to": "see a 'Punching Message' outline instead of a table of contents",
        "so_that": "I can understand the core arguments of the document at a glance without reading the full text",
        "acceptance_criteria": [
          "Structure is generated by AI, not regex",
          "Each section has a 'punching_message' summary",
          "Hierarchy represents logical flow, not just formatting",
          "UI displays the nested structure correctly"
        ]
      }
    ],
    "technical_constraints": [
      "Use `OpenRouterClient` for LLM calls",
      "Strictly typed interfaces for LLM response parsing",
      "Max nesting depth: 5 levels",
      "Maintain backward compatibility with `Section` type in `shared/src/types.ts`",
      "Do NOT remove the original `DocumentParser` regex logic yet (it serves as a fallback and initial state)"
    ],
    "verification_plan": {
      "automated_tests": [
        "npm test backend/src/services/visualization/__tests__/structure_ai.test.ts"
      ],
      "manual_verification": [
        "Upload a document",
        "Check console logs for 'Targeting structure-analysis prompt'",
        "Verify 'Structured View' tab in UI shows the new AI-generated hierarchy"
      ]
    }
  }
}
