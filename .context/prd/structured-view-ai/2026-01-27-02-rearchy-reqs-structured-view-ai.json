{
  "metadata": {
    "agent": "Rearchy",
    "created_at": "2026-01-27T00:00:00Z",
    "source_prompt_file": "2026-01-27-01-maestro-prompt-structured-view-ai.json"
  },
  "requirements": [
    {
      "id": "REQ-001",
      "category": "Backend",
      "title": "Create Structure Analysis Prompt",
      "description": "Implement a new prompt template in `backend/src/prompts/structureAnalysisPrompt.ts`. The prompt should instruct the LLM to act as an elite editor, analyzing the text to extract a logical hierarchy (levels 1-5). It must generate a JSON array of objects containing `title`, `level` (1-5), `summary`, and `punching_message`. The 'punching_message' must capture the 'So What?' or core insight of the section.",
      "acceptance_criteria": [
        "File `backend/src/prompts/structureAnalysisPrompt.ts` exists",
        "Prompt explicitly requests a flat JSON list",
        "Prompt instructs LLM to focus on 'Punching Message' (core insight)",
        "Prompt enforces max depth of 5 levels"
      ],
      "priority": "High"
    },
    {
      "id": "REQ-002",
      "category": "Backend",
      "title": "Update Visualization Generator Service",
      "description": "Modify `backend/src/services/visualization/visualizationGenerator.ts`. Change `generateStructuredView` to be asynchronous. Integrate the `OpenRouterClient` to call the LLM using the prompt from REQ-001. Parse the response into a strictly typed array.",
      "acceptance_criteria": [
        "`generateStructuredView` is async",
        "Service calls OpenRouter API",
        "Response is validated against a TypeScript interface"
      ],
      "priority": "High"
    },
    {
      "id": "REQ-003",
      "category": "Backend",
      "title": "Implement Hierarchy Reconstruction Logic",
      "description": "In `visualizationGenerator.ts`, implement a private helper method `reconstructHierarchy(flatSections: FlatSection[])` to convert the LLM's flat list into the recursive `Section` tree structure used by the application (`shared/src/types.ts`).",
      "acceptance_criteria": [
        "Converts flat list (levels 1-5) to nested `Section[]` tree",
        "Handles missing intermediate levels gracefully if possible",
        "Output matches `Section` interface in `shared/src/types.d.ts`"
      ],
      "priority": "High"
    },
    {
      "id": "REQ-004",
      "category": "Backend",
      "title": "Implement Resilience Fallback",
      "description": "Ensure `generateStructuredView` wraps the LLM call in a try/catch block. If the AI generation fails (timeout, parsing error, API error), return the existing `document.structure` (generated by the regex parser) as a fallback.",
      "acceptance_criteria": [
        "LLM failure does not crash the request",
        "Returns regex-based structure (`doc.structure`) on error",
        "Error is logged to console with context"
      ],
      "priority": "Medium"
    },
    {
      "id": "REQ-005",
      "category": "Backend",
      "title": "Verify Route Integration",
      "description": "Review and update `backend/src/routes/documents.ts` to ensure the visualization endpoint correctly awaits the updated asynchronous `generateStructuredView` function.",
      "acceptance_criteria": [
        "Route handler uses `await` for visualization generation",
        "Compiles without type errors regarding Promise<Section[]> vs Section[]"
      ],
      "priority": "High"
    },
    {
      "id": "REQ-006",
      "category": "Testing",
      "title": "Unit Tests for Structure Generation",
      "description": "Create a new test file `backend/src/services/visualization/__tests__/structure_ai.test.ts`. Test the hierarchy reconstruction logic with mock flat data. Test the fallback mechanism by mocking an LLM failure.",
      "acceptance_criteria": [
        "Tests pass for flat-to-tree conversion",
        "Tests pass for fallback scenario",
        "Command `npm test backend/src/services/visualization/__tests__/structure_ai.test.ts` succeeds"
      ],
      "priority": "Medium"
    },
    {
      "id": "REQ-007",
      "category": "Frontend",
      "title": "Verify UI Display",
      "description": "Verify that the 'Structured View' tab in the document details page (`/documents/:id`) correctly renders the new `punching_message` if available, or maintains existing behavior. (Note: This assumes the frontend generic `Section` component renders the summary/content provided).",
      "acceptance_criteria": [
        "Navigate to `/documents/:id`",
        "Select 'Structured View' tab",
        "Hierarchy is displayed correctly"
      ],
      "priority": "Low"
    }
  ]
}
