<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goose Depth Graph - Cascade Flow (15)</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="../styles.css" rel="stylesheet">
    <script src="../data.js"></script>
    <!-- 
      EXCEPTION: Use of CSS custom properties (--indent-level) for dynamic 
      indentation in the cascade view. This allows visual hierarchy representation
      without calculating pixel coordinates.
    -->
    <style>
        .cascade-line {
            position: absolute;
            left: 1.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-border-subtle);
            z-index: 0;
        }
        
        .cascade-node {
            --indent-level: 0;
            margin-left: calc(var(--indent-level) * 1.5rem);
            position: relative;
        }
        
        .cascade-node::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 1.5rem;
            width: 1.5rem;
            height: 1px;
            background: var(--color-border-subtle);
        }

        .cascade-connector {
            position: absolute;
            left: 0;
            top: 50%;
            width: 1rem;
            height: 1px;
            background: var(--color-border-subtle);
            transform: translateX(-100%);
        }

        /* Node states */
        .cascade-node.active {
            --indent-level: 1;
        }
        
        .cascade-node:hover .cascade-connector {
            background: var(--aurora-1);
            width: 1.5rem;
        }

        .depth-indicator {
            background: conic-gradient(
                from 180deg,
                var(--aurora-1) 0deg,
                var(--nova-1) 180deg,
                var(--color-text-disabled) 360deg
            );
        }
    </style>
</head>
<body class="bg-[var(--color-background-primary)] text-[var(--color-text-primary)] p-8">
    <div id="root"></div>

    <script type="text/babel">
        // --- Card Components ---
        const ExpandingCard = ({ node, level = 0, onToggle, isExpanded }) => {
            const depthPercent = (node.true_depth / 10) * 100;
            const depthColor = node.true_depth >= 8.5 ? 'var(--aurora-1)' : 
                               node.true_depth >= 8.0 ? 'var(--nova-1)' : 
                               'var(--color-text-disabled)';
            
            return (
                <div 
                    className={`
                        cascade-node relative pl-6 pr-4 py-3 mb-2 rounded-lg
                        bg-[var(--color-surface-elevated)]
                        border border-[var(--color-border-base)]
                        transition-all duration-200
                        hover:border-[var(--aurora-1)]
                        hover:shadow-[var(--elevation-md)]
                        cursor-pointer
                        ${isExpanded ? 'ring-2 ring-[var(--aurora-1)] ring-opacity-50' : ''}
                    `}
                    style={{ '--indent-level': level }}
                    onClick={() => onToggle(node.id)}
                >
                    <div className="cascade-connector"></div>
                    
                    <div className="flex items-start gap-3">
                        {/* Depth Indicator Bar */}
                        <div className="flex flex-col items-center gap-1 min-w-[4px]">
                            <div 
                                className="w-1 rounded-full"
                                style={{ 
                                    height: `${Math.max(20, depthPercent * 1.5)}%`,
                                    background: depthColor,
                                    opacity: 0.6
                                }}
                            ></div>
                            <span className="text-[10px] font-mono text-[var(--color-text-tertiary)]">
                                {node.true_depth}
                            </span>
                        </div>

                        {/* Content */}
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center justify-between gap-2">
                                <h4 className="font-bold text-sm text-[var(--color-text-primary)] truncate">
                                    {node.topic}
                                </h4>
                                <div className="flex items-center gap-2 shrink-0">
                                    {isExpanded ? (
                                        <span className="text-[10px] text-[var(--aurora-1)] font-bold">−</span>
                                    ) : (
                                        <span className="text-[10px] text-[var(--color-text-secondary)]">+</span>
                                    )}
                                </div>
                            </div>
                            
                            <p className="text-xs text-[var(--color-text-secondary)] line-clamp-1 mt-0.5">
                                {node.topic_summary}
                            </p>

                            {isExpanded && (
                                <div className="mt-3 space-y-2 animate-fade-in">
                                    <div className="text-xs leading-relaxed text-[var(--color-text-primary)] bg-[var(--color-background-tertiary)] p-2 rounded">
                                        {node.extended_summary}
                                    </div>

                                    <div className="grid grid-cols-3 gap-2">
                                        <div className="bg-[var(--color-surface-base)] p-2 rounded text-center">
                                            <div className="text-[9px] text-[var(--color-text-tertiary)]">COG</div>
                                            <div className="font-mono font-bold text-sm">{node.cognitive}</div>
                                        </div>
                                        <div className="bg-[var(--color-surface-base)] p-2 rounded text-center">
                                            <div className="text-[9px] text-[var(--color-text-tertiary)]">EPI</div>
                                            <div className="font-mono font-bold text-sm">{node.epistemic}</div>
                                        </div>
                                        <div className="bg-[var(--color-surface-base)] p-2 rounded text-center">
                                            <div className="text-[9px] text-[var(--color-text-tertiary)]">CAU</div>
                                            <div className="font-mono font-bold text-sm">{node.causal}</div>
                                        </div>
                                    </div>

                                    {node.signals.grounding.length > 0 && (
                                        <div className="flex flex-wrap gap-1">
                                            {node.signals.grounding.map((s, i) => (
                                                <span key={i} className="px-2 py-0.5 text-[10px] bg-[var(--aurora-1)] bg-opacity-20 text-[var(--aurora-1)] rounded-full border border-[var(--aurora-1)] border-opacity-30">
                                                    {s}
                                                </span>
                                            ))}
                                        </div>
                                    )}

                                    {node.feedback && (
                                        <div className="text-xs p-2 bg-[var(--color-semantic-warning-background)] border border-[var(--color-semantic-warning-border)] rounded text-[var(--color-semantic-warning-text)]">
                                            <strong>Feedback:</strong> {node.feedback}
                                        </div>
                                    )}

                                    <div className="pt-2 border-t border-[var(--color-border-subtle)]">
                                        <div className="text-[10px] text-[var(--color-text-tertiary)]">Additional Info:</div>
                                        <div className="text-[10px] text-[var(--color-text-secondary)]">
                                            {node.additionalInfo.cognitive_level} • {node.additionalInfo.epistemic_level}
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [expandedIds, setExpandedIds] = React.useState(new Set([1, 13]));
            const [flowMode, setFlowMode] = React.useState('structural'); // 'structural' or 'depth'

            // Define cascade structure based on thematic flow
            const cascadeStructure = {
                structural: [
                    { id: 1, level: 0 }, // Thesis
                    { id: 2, level: 1 }, // Macro
                    { id: 3, level: 2 }, // K-Shaped
                    { id: 4, level: 2 }, // Wage Paradox
                    { id: 5, level: 2 }, // Silent Firing
                    { id: 6, level: 3 }, // Flattening
                    { id: 7, level: 3 }, // Agentic
                    { id: 8, level: 2 }, // Layoffs
                    { id: 9, level: 3 }, // Tech Sector
                    { id: 10, level: 3 }, // BPO
                    { id: 11, level: 3 }, // Prof Services
                    { id: 12, level: 3 }, // Creative
                    { id: 13, level: 2 }, // Entry Crisis (Synthesis)
                    { id: 14, level: 3 }, // Social/Psych
                    { id: 15, level: 3 }, // Policy
                ],
                depth: GRAPH_DATA
                    .map(n => ({ id: n.id, level: 0 }))
                    .sort((a, b) => {
                        const nodeA = GRAPH_DATA.find(n => n.id === a.id);
                        const nodeB = GRAPH_DATA.find(n => n.id === b.id);
                        return nodeB.true_depth - nodeA.true_depth;
                    })
            };

            const handleToggle = (id) => {
                const newExpanded = new Set(expandedIds);
                if (newExpanded.has(id)) {
                    newExpanded.delete(id);
                } else {
                    newExpanded.add(id);
                }
                setExpandedIds(newExpanded);
            };

            const handleExpandAll = () => {
                setExpandedIds(new Set(GRAPH_DATA.map(n => n.id)));
            };

            const handleCollapseAll = () => {
                setExpandedIds(new Set([1, 13]));
            };

            return (
                <div className="max-w-[1400px] mx-auto space-y-6">
                    <header className="mb-6">
                        <div className="flex items-center justify-between mb-4">
                            <div>
                                <h1 className="text-4xl font-bold mb-2 text-gradient aurora">
                                    Cascade Flow View
                                </h1>
                                <p className="text-[var(--color-text-secondary)] text-lg">
                                    Experiment 15: Hierarchical flow with progressive depth exploration
                                </p>
                            </div>
                            <div className="flex gap-2">
                                <a href="page14.html" className="btn btn-secondary px-4 py-2 rounded-lg text-sm">← Prev</a>
                                <span className="btn btn-primary px-4 py-2 rounded-lg text-sm">15/15</span>
                            </div>
                        </div>

                        {/* Control Bar */}
                        <div className="bg-[var(--color-surface-elevated)] rounded-xl border border-[var(--color-border-base)] p-4 space-y-3">
                            <div className="flex items-center gap-4">
                                <div className="flex items-center gap-2">
                                    <span className="text-sm font-bold text-[var(--color-text-secondary)]">Flow Mode:</span>
                                    <button 
                                        onClick={() => setFlowMode('structural')}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${
                                            flowMode === 'structural' 
                                                ? 'bg-[var(--aurora-1)] text-white' 
                                                : 'bg-[var(--color-surface-base)] text-[var(--color-text-secondary)]'
                                        }`}
                                    >
                                        Structural
                                    </button>
                                    <button 
                                        onClick={() => setFlowMode('depth')}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-semibold ${
                                            flowMode === 'depth' 
                                                ? 'bg-[var(--aurora-1)] text-white' 
                                                : 'bg-[var(--color-surface-base)] text-[var(--color-text-secondary)]'
                                        }`}
                                    >
                                        By Depth
                                    </button>
                                </div>

                                <div className="h-6 w-px bg-[var(--color-border-subtle)]"></div>

                                <div className="flex gap-2">
                                    <button 
                                        onClick={handleExpandAll}
                                        className="text-xs px-3 py-1.5 rounded bg-[var(--color-background-secondary)] hover:bg-[var(--color-background-tertiary)] border border-[var(--color-border-base)]"
                                    >
                                        Expand All
                                    </button>
                                    <button 
                                        onClick={handleCollapseAll}
                                        className="text-xs px-3 py-1.5 rounded bg-[var(--color-background-secondary)] hover:bg-[var(--color-background-tertiary)] border border-[var(--color-border-base)]"
                                    >
                                        Collapse All
                                    </button>
                                </div>

                                <div className="flex-1"></div>

                                <div className="flex items-center gap-3 text-xs text-[var(--color-text-tertiary)]">
                                    <div className="flex items-center gap-1">
                                        <div className="w-3 h-3 rounded-full bg-[var(--aurora-1)]"></div>
                                        <span>≥ 8.5</span>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <div className="w-3 h-3 rounded-full bg-[var(--nova-1)]"></div>
                                        <span>8.0 - 8.4</span>
                                    </div>
                                    <div className="flex items-center gap-1">
                                        <div className="w-3 h-3 rounded-full bg-[var(--color-text-disabled)]"></div>
                                        <span>under 8.0</span>
                                    </div>
                                </div>
                            </div>

                            <div className="text-xs text-[var(--color-text-secondary)]">
                                {flowMode === 'structural' 
                                    ? 'Showing thematic progression from core thesis to systemic impact'
                                    : 'Sorted by analytical depth (highest to lowest)'}
                            </div>
                        </div>
                    </header>

                    {/* Cascade Container */}
                    <div className="relative">
                        {/* Main Connector Line */}
                        <div className="absolute left-3 top-0 bottom-0 w-0.5 bg-[var(--color-border-subtle)]"></div>

                        <div className="space-y-2 py-4">
                            {cascadeStructure[flowMode].map((item) => {
                                const node = GRAPH_DATA.find(n => n.id === item.id);
                                const isExpanded = expandedIds.has(node.id);
                                
                                return (
                                    <ExpandingCard 
                                        key={node.id}
                                        node={node}
                                        level={item.level}
                                        isExpanded={isExpanded}
                                        onToggle={handleToggle}
                                    />
                                );
                            })}
                        </div>
                    </div>

                    {/* Summary Footer */}
                    <div className="bg-[var(--color-surface-elevated)] rounded-xl border border-[var(--color-border-base)] p-4 mt-6">
                        <div className="flex items-center justify-between text-sm">
                            <div className="flex items-center gap-6">
                                <div>
                                    <span className="text-[var(--color-text-tertiary)]">Total Nodes:</span>
                                    <span className="font-bold ml-2">15</span>
                                </div>
                                <div>
                                    <span className="text-[var(--color-text-tertiary)]">Expanded:</span>
                                    <span className="font-bold ml-2 text-gradient aurora">{expandedIds.size}</span>
                                </div>
                                <div>
                                    <span className="text-[var(--color-text-tertiary)]">Avg Depth:</span>
                                    <span className="font-bold ml-2 font-mono">
                                        {(GRAPH_DATA.reduce((sum, n) => sum + n.true_depth, 0) / GRAPH_DATA.length).toFixed(2)}
                                    </span>
                                </div>
                            </div>
                            <div className="text-xs text-[var(--color-text-tertiary)]">
                                Visualization Complete • Use Back to Review Other Views
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
